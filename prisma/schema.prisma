// Prisma schema for SavvyDealsHub (Postgres/Neon)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model Category {
  id        Int        @id @default(autoincrement())
  slug      String     @unique
  name      String

  parentId  Int?
  parent    Category?  @relation("Subcategories", fields: [parentId], references: [id])
  children  Category[] @relation("Subcategories")

  products  Product[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Product {
  id          Int      @id @default(autoincrement())
  sku         String   @unique
  title       String
  description String
  price       Float
  imageUrl    String?
  url         String   // affiliate URL

  categoryId  Int
  category    Category @relation(fields: [categoryId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- True Price Comparison: Offers uploaded via authorised feeds (CSV/JSON/APIs) ---
// We keep `Product` above for the existing site catalogue.
// `Offer` is the comparison engine input: it can contain multiple retailer listings per product.

enum OfferCondition {
  New
  Used
  Refurbished
  Unknown
}

enum RetailerMembership {
  AMAZON_PRIME
  NECTAR
  CLUBCARD
}


enum AffiliateNetwork {
  amazon
  skimlinks
  ebay_partner
  direct
}

model Offer {
  id                 Int               @id @default(autoincrement())

  // A stable identifier you control (e.g. barcode/MPN/retailer SKU). Required for dedupe.
  sku                String
  title              String
  description        String?
  category           String

  // Retailer listing data
  retailer           String
  url                String
  deepLink           String?
  country            String            @default("UK")
  affiliateNetwork   AffiliateNetwork  @default(direct)
  imageUrl           String?

  // Prices
  price              Float?
  shippingPrice      Float?
  shippingIncluded   Boolean           @default(false)

  // Metadata
  condition          OfferCondition    @default(Unknown)
  membershipRequired Boolean           @default(false)
  membershipType     RetailerMembership?

  // Sponsored placements (OFF by default; always labelled if enabled)
  isSponsored        Boolean           @default(false)
  sponsorLabel       String?

  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  clicks             ClickEvent[]
  snapshots          OfferPriceSnapshot[]

  @@unique([sku, retailer, url])
  @@index([category])
}

// --- Offer Freshness & Price History ---
// We store lightweight snapshots of offer price components over time.
// This powers "biggest drops", trend views, and more accurate alerts later.
model OfferPriceSnapshot {
  id               Int      @id @default(autoincrement())

  offerId          Int
  offer            Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)

  price            Float?
  shippingPrice    Float?
  shippingIncluded Boolean  @default(false)

  capturedAt       DateTime @default(now())

  @@index([capturedAt])
  @@index([offerId, capturedAt])
}

// --- Revenue Intelligence ---
// Minimal, GDPR-safe click events for outbound clicks.
// We intentionally store no IP, no cookie IDs, and no user agents.
model ClickEvent {
  id        Int      @id @default(autoincrement())

  offerId   Int
  offer     Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)

  retailer  String
  category  String
  source    String?
  cta       String?

  country          String?
  affiliateNetwork AffiliateNetwork?

  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([retailer])
  @@index([category])
}

// Auth tables (NextAuth-compatible)
// Keep these even if signup is "demo" right now; weâ€™ll wire the API next.
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?

  // For email/password signup (your register page)
  passwordHash  String?

  accounts      Account[]
  sessions      Session[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String

  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
